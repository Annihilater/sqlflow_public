最顶层的对象为 database。模型中包含的对象分为这几类： database object, schema object, hdfs object, SQL object。

模型中包含的关系为 relation, join 。

在数据血缘模型中，主要为实体、属性和处理者（处理者可以看成是一种特殊类型的实体）。实体包含多个属性。处理者进行数据转换，可进行实体级的数据转换，也可以进行属性级的数据转换。

在RDBMS中，表，视图为实体，表中的字段称为表这个实体的属性。create view 等语句称为处理者。表级的数据血缘就是SQL语句对表进行数据转换。

字段级的数据血缘就是SQL 表达式对数据进行转换。

在HDFS中，文件为实体，文件中的字段称为这个文件的属性。

数据血缘模型包含两个主要的组成部分：实体和属性间的关系，用dbobjs来存储实体，用relations来存储属性间的关系。

最为典型的例子是dbobjs中存储的表，relations中存储的字段间的关系。

![image.png](https://images.gitee.com/uploads/images/2021/1022/154144_2642840e_8136809.png)

## 基础数据血缘模型

relations中存储属性间的关系没有合并，没有形成完整的数据流。

目前只支持从 SQL 脚本生成该模型。以后需逐渐添加分析其它数据源，生成该模型。可以复用该模型之后路径中的所有功能。

参考 apache atlas type system: https://atlas.apache.org/#/TypeSystem

![image.png](https://images.gitee.com/uploads/images/2021/1022/175019_c1d39fab_8136809.png)

为了支持从不同的源头采集数据血缘模型，对该模型包含的内容和格式做如下的约定：

### 模型中的实体

所有进入该模型的数据首先抽象为实体，例如RDBMS中的表。SQL语句也可以抽象为一个特殊类型的实体，即处理者。实体可以包含属性，例如表包含字段。

实体间可以建立关系，属性间也可以建立关系。

### 模型中的关系

关系分为两级，实体间的关系，例如RDBMS中的表直接的关系。属性间的关系，例如RDBMS中的字段间的关系。

一个关系包含一个目标对象和一个或多个源对象，还包含一个关系的类型，fdd: 实际的数据流。fdr: 影响数据流，impact。

### 模型中数据处理者

数据处理者是一种特殊的实体，它用来对数据实体进行数据转换。例如，一个 create view 语句就是一个处理者实体。一个SQL语句处理实体可以包含表达式处理者属性，就象表包含字段一样。表达式处理者一般进行字段级别的数据转换。

## 合并后的数据血缘模型

对基础模型中的relations中存储属性间的关系进行合并，形成完整的数据流。

## 1. Database object

- schema

## 2. Schema object

- table, including external table
- view
- procedure
- function
- trigger

## 3. Hdfs object

- file, such as `/user/data/pv_2008-06-08_us.txt, gs://bucket/path1.csv`
- directory, such as `s3://load/encrypted_files/`, `@exttable_part_stage/logs/`
- stage, this is a directory.

## 4. SQL object

Object created temporary during the execution of the SQL statement.

- select list
- merge insert
- merge update
- update set
- update select
- insert select
- function call
- union
- CTE
- pivot table
- snowflake pivot alias
- sql server open json
- sql server join property
- set of rows ( constructed through the values expression, used in the place where table occurs)
- process, this the the SQL query that does the data transform.

## 5. Relationship

* direct(fdd) and indirect  dataflow

## 6. join

## 7. Abbreviation of the object

The abbreviation of the object used in the diagram generated by the Gudu SQLFlow.

- CTE [C]
- directory [D]
- function [F]
- function call [F]
- file [FL]
- insert select [IS]
- join property [JP] (sql server)
- merge insert [MI]
- merge update [MU]
- open json [OJ] (sql server)
- pivot alias [PA] (snowflake)
- pivot table [PT]
- procedure [P]
- select list [L]
- set of rows [RW]
- stage [S]
- table [T]
- trigger [TR]
- union [U]
- update set [UE]
- update select [US]
- view [V]
